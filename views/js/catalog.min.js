/**
 * LaboData for Prestashop
 *
 * @author 161 SARL <contact@161.io>
 * @copyright (c) 161 SARL, https://161.io
 * @license https://161.io
 */
!function(s){"use strict";var r,c,u,p,l,f,b="LaboDataModalIgnore",o="full",m="edit",h="&euro;";function g(t){t=(""+t).replace(",",".");var a=parseFloat(t);return(isNaN(a)||a<0)&&(a=0),a}function y(t){return t.toFixed(2).replace(".",",")}function v(t){t=g(t),c.html(y(t))}function w(t,d){(t=s.extend({action:m,id:0,type:""},t)).id=parseInt(t.id);var i=u.find('[data-product="'+t.id+'"]');if(i.length){var n=i.find(".label-state"),a=s.ajax({url:u.data("url-import"),type:"POST",cache:!1,data:t,dataType:"json"});a.done(function(t){if(t&&t.success){var a=t.type,e=i.find('.btn[data-type="'+a+'"]');return e.removeClass("btn-default").addClass("btn-success").data("credit",0),a==o||1<i.find(".btn[data-type].btn-success").length?i.find(".btn[data-type]").removeClass("btn-default").addClass("btn-success").data("credit",0):i.find('.btn[data-type="full"]').data("credit",e.data("init-credit")),C(n,"success",r.stateDone),v(t.apiResponse.credit),void(d&&d())}C(n,"danger"),t&&t.apiResponse?(v(t.apiResponse.credit),t.apiResponse.error&&s.growl.error({title:"",size:"large",message:t.apiResponse.error.message||r.errorInternal})):s.growl.error({title:"",size:"large",message:r.errorInternal}),x(!1,!0)}),a.fail(function(t){C(n,"danger"),x(!1,!0)}),a.always(function(){k()||i.find("button").prop("disabled",!1).attr("disabled","")}),C(n,"default",r.stateProgress),i.find("button").prop("disabled",!0).attr("disabled","disabled")}else alert("Product not found : "+t.id)}function C(t,a,e){return"danger"!=a||e||(e="Error"),t.removeClass("label-default label-danger label-success").addClass("label-"+a).html(e)}var e=!1;function k(){return e}function x(t,a){(e=!!t)?(u.find("tbody .btn[data-type]").prop("disabled",!0),window.onbeforeunload=function(t){var a=r.importGroupExit;return(t=t||window.event)&&(t.returnValue=a),a}):(u.find("tbody .btn[data-type]").prop("disabled",!0),window.onbeforeunload=null,a&&u.find("tbody .label-state").html("Error"))}function I(){var t=u.find("tbody .btn.waiting").first();if(!t.length)return x(!1),void s.growl.notice({title:"",size:"large",message:r.importGroupDone});t.removeClass("waiting");var a=t.parents("[data-product]");C(a.find(".label-state"),"default",r.stateProgress),w({id:parseInt(a.data("product")),type:t.data("type")},I)}s(function(){r=window.LaboDataTranslate,c=s("#labodata-credit"),u=s("#labodata-result"),p=s("#modal-labodata-import"),l=s("#modal-labodata-import-group"),f=s("#modal-labodata-credit"),h=s("#labodata-currency").html(),u.find("[data-type][title]").tooltip({container:u}),f.find('[data-submit="modal"]').on("click",function(){window.open(s("#labodata-autopay").attr("href")),f.modal("hide")}),u.find("tbody .btn[data-credit]").on("click",function(){var t=s(this),a=t.parents("tr[data-product]"),e=t.data("type"),d=g(t.data("credit")),i=!d;t.tooltip("hide");var n=p.attr("id")+"-clone";if(s("#"+n).remove(),!i&&d>g(c.text()))f.modal("show");else if(i&&"buy"==m&&Cookies.set(b,!1),"true"!=Cookies.get(b)){var o=a.find("[data-prod-title]").html(),r=t.data("credit")+h,l=p.clone();l.attr("id",n),l.find('[data-bought="'+(i?"0":"1")+'"]').addClass("hide"),l.find("[data-type]").not('[data-type="'+e+'"]').addClass("hide"),l.find('[data-val="title"]').html(o),l.find('[data-val="price"]').html(r),l.find('[data-submit="modal"]').on("click",function(){m=l.find('[name="modal-action"]:checked').val();var t=l.find('[name="modal-ignore"]').prop("checked");Cookies.set(b,t),w({id:a.data("product"),type:e}),l.modal("hide")}),l.insertAfter(u).modal("show")}else w({id:a.data("product"),type:e})}),s("#labodata-import-group .btn[data-type]").on("click",function(){if(k())s.growl.warning({title:"",size:"large",message:r.importGroupProgress});else{var t=s(this),a=t.data("type"),e=u.find('tbody .btn[data-type="'+a+'"]'),d=0;e.each(function(){d+=g(s(this).data("credit"))});var i=!d;t.tooltip("hide");var n=l.attr("id")+"-clone";if(s("#"+n).remove(),!i&&d>g(c.text()))f.modal("show");else{var o=l.clone();o.attr("id",n),o.find('[data-bought="'+(i?"0":"1")+'"]').addClass("hide"),o.find("[data-type]").not('[data-type="'+a+'"]').addClass("hide"),o.find('[data-val="product"]').html(e.length),o.find('[data-val="credit"]').html(y(d)+h),o.find('[data-submit="modal"]').on("click",function(){x(!0),e.addClass("waiting"),C(u.find("tbody .label-state"),"default",r.stateWait),o.modal("hide"),I()}),o.insertAfter(u).modal("show")}}})})}(jQuery);