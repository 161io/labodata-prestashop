/**
 * LaboData for Prestashop
 *
 * @author 161 SARL <contact@161.io>
 * @copyright (c) 161 SARL, https://161.io
 * @license https://161.io
 */
!function(r){"use strict";var i,l,s,c,p,u,f,b="LaboDataModalIgnore",m="full",g="edit";function h(t){t=(""+t).replace(",",".");t=parseFloat(t);return(isNaN(t)||t<0)&&(t=0),t}function v(t){return t.toFixed(2).replace(".",",")}function y(t){t=h(t),l.html(v(t))}function w(t,d){(t=r.extend({action:g,id:0,type:""},t)).id=parseInt(t.id);var o,a,n=s.find('[data-product="'+t.id+'"]');n.length?(o=n.find(".label-state"),(a=r.ajax({url:s.data("url-import"),type:"POST",data:t,dataType:"json"})).done(function(t){if(t&&t.success){var a=t.type,e=n.find('.btn[data-type="'+a+'"]');return e.removeClass("btn-default").addClass("btn-success").data("credit",0),a==m||1<n.find(".btn[data-type].btn-success").length?n.find(".btn[data-type]").removeClass("btn-default").addClass("btn-success").data("credit",0):n.find('.btn[data-type="full"]').data("credit",e.data("init-credit")),C(o,"success",i.stateDone),y(t.apiResponse.credit),void(d&&d())}C(o,"danger"),t&&t.apiResponse?(y(t.apiResponse.credit),t.apiResponse.error&&r.growl.error({title:"",size:"large",message:t.apiResponse.error.message||i.errorInternal})):r.growl.error({title:"",size:"large",message:i.errorInternal}),x(!1,!0)}),a.fail(function(t){C(o,"danger"),x(!1,!0)}),a.always(function(){k||n.find("button").prop("disabled",!1).attr("disabled","")}),C(o,"default",i.stateProgress),n.find("button").prop("disabled",!0).attr("disabled","disabled")):alert("Product not found : "+t.id)}function C(t,a,e){return"danger"!=a||e||(e="Error"),t.removeClass("label-default label-danger label-success").addClass("label-"+a).html(e)}var k=!1;function x(t,a){(k=!!t)?(s.find("tbody .btn[data-type]").prop("disabled",!0),window.onbeforeunload=function(t){var a=i.importGroupExit;return(t=t||window.event)&&(t.returnValue=a),a}):(s.find("tbody .btn[data-type]").prop("disabled",!0),window.onbeforeunload=null,a&&s.find("tbody .label-state").html("Error"))}function I(){var t=s.find("tbody .btn.waiting").first();if(!t.length)return x(!1),void r.growl.notice({title:"",size:"large",message:i.importGroupDone});t.removeClass("waiting");var a=t.parents("[data-product]");C(a.find(".label-state"),"default",i.stateProgress),w({id:parseInt(a.data("product")),type:t.data("type")},I)}r(function(){i=window.LaboDataTranslate,l=r("#labodata-credit"),s=r("#labodata-result"),c=r("#modal-labodata-import"),p=r("#modal-labodata-import-group"),u=r("#modal-labodata-credit"),f=r("#labodata-currency").html(),s.find("[data-type][title]").tooltip({container:s}),u.find('[data-submit="modal"]').on("click",function(){window.open(r("#labodata-autopay").attr("href")),u.modal("hide")}),r(".dropdown-menu-order").each(function(){var a=r(this),e=a.prev(".dropdown-toggle"),d=a.parents("form").find('input[name="order"]');a.find("a").on("click",function(){var t=r(this);return e.dropdown("toggle"),a.find("li.active").removeClass("active"),e.find(".order-value-text").text(t.data("label")),t.parent().addClass("active"),d.val(t.data("value")),!1})}),r(".img-labodata-preview").on("click",function(){var t=r(this).find("img").clone();t.attr("src",t.attr("src").replace("100x100","300x300"));var a=r("#modal-labodata-preview");return a.find(".modal-body").html("").append(t),a.modal("show"),!1}),s.find("tbody .btn[data-credit]").on("click",function(){var t=r(this),a=t.parents("tr[data-product]"),e=t.data("type"),d=h(t.data("credit")),o=!d;t.tooltip("hide");var n,i=c.attr("id")+"-clone";r("#"+i).remove(),!o&&d>h(l.text())?u.modal("show"):(o&&"buy"==g&&Cookies.set(b,!1),"true"!=Cookies.get(b)?(d=a.find("[data-prod-title]").html(),t=t.data("credit")+f,(n=c.clone()).attr("id",i),n.find('[data-bought="'+(o?"0":"1")+'"]').addClass("hide"),n.find("[data-type]").not('[data-type="'+e+'"]').addClass("hide"),n.find('[data-val="title"]').html(d),n.find('[data-val="price"]').html(t),n.find('[data-submit="modal"]').on("click",function(){g=n.find('[name="modal-action"]:checked').val();var t=n.find('[name="modal-ignore"]').prop("checked");Cookies.set(b,t),w({id:a.data("product"),type:e}),n.modal("hide")}),n.insertAfter(s).modal("show")):w({id:a.data("product"),type:e}))}),r("#labodata-import-group .btn[data-type]").on("click",function(){var t,a,e,d,o,n;k?r.growl.warning({title:"",size:"large",message:i.importGroupProgress}):(t=(o=r(this)).data("type"),a=s.find('tbody .btn[data-type="'+t+'"]'),e=0,a.each(function(){e+=h(r(this).data("credit"))}),d=!e,o.tooltip("hide"),o=p.attr("id")+"-clone",r("#"+o).remove(),!d&&e>h(l.text())?u.modal("show"):((n=p.clone()).attr("id",o),n.find('[data-bought="'+(d?"0":"1")+'"]').addClass("hide"),n.find("[data-type]").not('[data-type="'+t+'"]').addClass("hide"),n.find('[data-val="product"]').html(a.length),n.find('[data-val="credit"]').html(v(e)+f),n.find('[data-submit="modal"]').on("click",function(){x(!0),a.addClass("waiting"),C(s.find("tbody .label-state"),"default",i.stateWait),n.modal("hide"),I()}),n.insertAfter(s).modal("show")))})})}(jQuery);