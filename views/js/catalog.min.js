/**
 * LaboData for Prestashop
 *
 * @author 161 SARL <contact@161.io>
 * @copyright (c) 161 SARL, https://161.io
 * @license https://161.io
 */
!function(r){"use strict";var i,l,s,c,p,u,f,b="LaboDataModalIgnore",m="edit";function g(t){t=(""+t).replace(",",".");t=parseFloat(t);return t=isNaN(t)||t<0?0:t}function h(t){return t.toFixed(2).replace(".",",")}function y(t){t=g(t),l.html(h(t))}function v(t,d){(t=r.extend({action:m,id:0,type:""},t)).id=parseInt(t.id);var n,a,o=s.find('[data-product="'+t.id+'"]');o.length?(n=o.find(".label-state"),(a=r.ajax({url:s.data("url-import"),type:"POST",data:t,dataType:"json"})).done(function(t){var a,e;t&&t.success?(a=t.type,(e=o.find('.btn[data-type="'+a+'"]')).removeClass("btn-default").addClass("btn-success").data("credit",0),"full"==a||1<o.find(".btn[data-type].btn-success").length?o.find(".btn[data-type]").removeClass("btn-default").addClass("btn-success").data("credit",0):o.find('.btn[data-type="full"]').data("credit",e.data("init-credit")),w(n,"success",i.stateDone),y(t.apiResponse.credit),d&&d()):(w(n,"danger"),t&&t.apiResponse?(y(t.apiResponse.credit),t.apiResponse.error&&r.growl.error({title:"",size:"large",message:t.apiResponse.error.message||i.errorInternal})):r.growl.error({title:"",size:"large",message:i.errorInternal}),k(!1,!0))}),a.fail(function(t){w(n,"danger"),k(!1,!0)}),a.always(function(){C||o.find("button").prop("disabled",!1).attr("disabled","")}),w(n,"default",i.stateProgress),o.find("button").prop("disabled",!0).attr("disabled","disabled")):alert("Product not found : "+t.id)}function w(t,a,e){"danger"==a&&(e=e||"Error"),t.removeClass("label-default label-danger label-success").addClass("label-"+a).html(e)}var C=!1;function k(t,a){(C=!!t)?(s.find("tbody .btn[data-type]").prop("disabled",!0),window.onbeforeunload=function(t){var a=i.importGroupExit;return(t=t||window.event)&&(t.returnValue=a),a}):(s.find("tbody .btn[data-type]").prop("disabled",!0),window.onbeforeunload=null,a&&s.find("tbody .label-state").html("Error"))}function x(){var t,a=s.find("tbody .btn.waiting").first();a.length?(a.removeClass("waiting"),w((t=a.parents("[data-product]")).find(".label-state"),"default",i.stateProgress),v({id:parseInt(t.data("product")),type:a.data("type")},x)):(k(!1),r.growl.notice({title:"",size:"large",message:i.importGroupDone}))}r(function(){i=window.LaboDataTranslate,l=r("#labodata-credit"),s=r("#labodata-result"),c=r("#modal-labodata-import"),p=r("#modal-labodata-import-group"),u=r("#modal-labodata-credit"),f=r("#labodata-currency").html(),s.find("[data-type][title]").tooltip({container:s}),u.find('[data-submit="modal"]').on("click",function(){window.open(r("#labodata-autopay").attr("href")),u.modal("hide")}),r(".dropdown-menu-order").each(function(){var a=r(this),e=a.prev(".dropdown-toggle"),d=a.parents("form").find('input[name="order"]');a.find("a").on("click",function(){var t=r(this);return e.dropdown("toggle"),a.find("li.active").removeClass("active"),e.find(".order-value-text").text(t.data("label")),t.parent().addClass("active"),d.val(t.data("value")),!1})}),r(".img-labodata-preview").on("click",function(){var t=r(this).find("img").clone(),a=(t.attr("src",t.attr("src").replace("100x100","300x300")),r("#modal-labodata-preview"));return a.find(".modal-body").html("").append(t),a.modal("show"),!1}),s.find("tbody .btn[data-credit]").on("click",function(){var a,t=r(this),e=t.parents("tr[data-product]"),d=t.data("type"),n=g(t.data("credit")),o=!n,i=(t.tooltip("hide"),c.attr("id")+"-clone");r("#"+i).remove(),!o&&n>g(l.text())?u.modal("show"):(o&&"buy"==m&&Cookies.set(b,!1),"true"==Cookies.get(b)?v({id:e.data("product"),type:d}):(n=e.find("[data-prod-title]").html(),t=t.data("credit")+f,(a=c.clone()).attr("id",i),a.find('[data-bought="'+(o?"0":"1")+'"]').addClass("hide"),a.find("[data-type]").not('[data-type="'+d+'"]').addClass("hide"),a.find('[data-val="title"]').html(n),a.find('[data-val="price"]').html(t),a.find('[data-submit="modal"]').on("click",function(){m=a.find('[name="modal-action"]:checked').val();var t=a.find('[name="modal-ignore"]').prop("checked");Cookies.set(b,t),v({id:e.data("product"),type:d}),a.modal("hide")}),a.insertAfter(s).modal("show")))}),r("#labodata-import-group .btn[data-type]").on("click",function(){var t,a,e,d,n,o;C?r.growl.warning({title:"",size:"large",message:i.importGroupProgress}):(t=(n=r(this)).data("type"),a=s.find('tbody .btn[data-type="'+t+'"]'),e=0,a.each(function(){e+=g(r(this).data("credit"))}),d=!e,n.tooltip("hide"),n=p.attr("id")+"-clone",r("#"+n).remove(),(!d&&e>g(l.text())?u:((o=p.clone()).attr("id",n),o.find('[data-bought="'+(d?"0":"1")+'"]').addClass("hide"),o.find("[data-type]").not('[data-type="'+t+'"]').addClass("hide"),o.find('[data-val="product"]').html(a.length),o.find('[data-val="credit"]').html(h(e)+f),o.find('[data-submit="modal"]').on("click",function(){k(!0),a.addClass("waiting"),w(s.find("tbody .label-state"),"default",i.stateWait),o.modal("hide"),x()}),o.insertAfter(s))).modal("show"))})})}(jQuery);